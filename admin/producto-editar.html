<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Admin — Ver producto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="../assets/css/admin.css" rel="stylesheet">
</head>
<body class="admin">
  <header id="admin-header"></header>

  <div class="a-layout">
    <aside id="admin-aside" class="a-aside"></aside>

    <main id="admin-main" class="a-main container">
      <nav class="breadcrumb">
        <a href="index.html">Dashboard</a><span class="sep">/</span>
        <a href="productos-listado.html">Productos</a><span class="sep">/</span>
        <span class="muted">Detalle</span>
      </nav>

      <h1 id="title">Producto</h1>

      <div id="notFound" class="card hidden">
        <p class="error">No se encontró el producto solicitado.</p>
        <div style="display:flex;gap:10px;margin-top:8px">
          <a class="btn" href="productos-listado.html">Volver al listado</a>
          <a class="btn primary" href="producto-nuevo.html">Crear nuevo</a>
        </div>
      </div>

      <div id="view" class="card hidden">
        <div class="grid" style="grid-template-columns:280px 1fr">
          <div>
            <div class="card" style="display:flex;align-items:center;justify-content:center;height:220px">
              <img id="img" alt="Imagen del producto" style="max-height:200px;max-width:100%;display:none">
              <span id="noImg" class="muted">Sin imagen</span>
            </div>
          </div>

          <div>
            <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
              <div>
                <div class="muted">ID</div>
                <div id="fId" style="font-weight:700">—</div>
              </div>
              <div>
                <div class="muted">Estado</div>
                <div id="fEstado"><span class="badge">—</span></div>
              </div>
              <div>
                <div class="muted">Precio</div>
                <div id="fPrecio" style="font-weight:700">—</div>
              </div>
              <div>
                <div class="muted">Stock</div>
                <div id="fStock">—</div>
              </div>
              <div>
                <div class="muted">Categoría</div>
                <div id="fCat">—</div>
              </div>
            </div>

            <div class="hr"></div>

            <div>
              <div class="muted">Nombre</div>
              <h2 id="fNombre" style="margin:.2rem 0 0 0">—</h2>
            </div>

            <div style="margin-top:8px">
              <div class="muted">Descripción</div>
              <p id="fDesc" style="margin:.2rem 0 0 0">—</p>
            </div>

            <div class="hr"></div>

            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <a id="btnEdit" class="btn" href="#">Editar</a>
              <button id="btnDel" class="btn danger">Eliminar</button>
              <a class="btn" href="productos-listado.html">Volver al listado</a>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <div class="a-dim" aria-hidden="true"></div>

  <script src="../assets/js/datos.js"></script>
  <script src="../assets/js/layout-admin.js"></script>
  <script>
    AX.mountLayout();

    const CLP=new Intl.NumberFormat('es-CL',{style:'currency',currency:'CLP',maximumFractionDigits:0});
    const qs=k=>new URLSearchParams(location.search).get(k);
    const isHttpUrl=s=>{try{const u=new URL(s);return u.protocol==='http:'||u.protocol==='https:'}catch{return false}};
    const badgeEstado=p=>{
      if(p.activo&&Number(p.stock)>0)return'<span class="badge ok">Activo</span>';
      if(Number(p.stock)<=0)return'<span class="badge warn">Sin stock</span>';
      return'<span class="badge">Inactivo</span>';
    };

    function paint(p){
      document.getElementById('view').classList.remove('hidden');
      document.getElementById('title').textContent='Producto #'+p.id;
      document.getElementById('fId').textContent=p.id;
      document.getElementById('fNombre').textContent=p.nombre||'—';
      document.getElementById('fPrecio').textContent=CLP.format(Number(p.precio||0));
      document.getElementById('fStock').textContent=String(Number(p.stock||0));
      document.getElementById('fCat').textContent=p.categoria||'—';
      document.getElementById('fEstado').innerHTML=badgeEstado(p);
      document.getElementById('fDesc').textContent=p.descripcion?p.descripcion:'—';

      const img=document.getElementById('img'),noImg=document.getElementById('noImg');
      img.onload=()=>{img.style.display='';noImg.style.display='none'};
      img.onerror=()=>{img.removeAttribute('src');img.style.display='none';noImg.style.display=''};
      const url=p.imagen&&isHttpUrl(p.imagen)?p.imagen:'';
      if(url){img.src=url}else{img.onerror()}
      document.getElementById('btnEdit').setAttribute('href','producto-editar.html?id='+encodeURIComponent(p.id));
    }

    function notFound(){
      document.getElementById('notFound').classList.remove('hidden');
    }

    function init(){
      const id=qs('id');
      if(!id){notFound();return}
      const get=window.DB?.products?.get?DB.products.get(id):null;
      if(get==null){
        if(!window.DB||!window.DB.products){addEventListener('nx:products-seeded',init,{once:true});return}
        notFound();return;
      }
      paint(get);

      document.getElementById('btnDel').addEventListener('click',()=>{
        if(confirm('¿Eliminar producto #'+get.id+' ?')){
          if(DB.products.remove(get.id))location.href='productos-listado.html';
          else alert('No se pudo eliminar (no encontrado).');
        }
      });
    }
    init();
  </script>
</body>
</html>
