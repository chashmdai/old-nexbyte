<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Admin — Productos (Listado)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="../assets/css/admin.css" rel="stylesheet">
  <style>
    .stickybar{position:sticky;top:8px;z-index:5;background:var(--ad-surface-2);border:1px solid var(--ad-border);border-radius:var(--ad-radius);padding:10px;box-shadow:var(--ad-shadow);margin:8px 0 10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .stickybar .search{flex:1 1 320px;display:flex;gap:8px}
    .stickybar .search input{width:100%}
    .stickybar .filters{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .stickybar .filters select{min-width:160px}
    #bulkBar{display:none;align-items:center;gap:8px;margin:8px 0 0;background:var(--ad-surface-2);border:1px solid var(--ad-border);border-radius:var(--ad-radius);padding:10px}
    #bulkBar.show{display:flex}
    .col-sel{width:42px}
    @media (max-width:900px){th[data-col="cat"],td[data-col="cat"]{display:none}.stickybar{top:6px}}
  </style>
</head>
<body class="admin">
  <header id="admin-header"></header>

  <div class="a-layout">
    <aside id="admin-aside" class="a-aside"></aside>

    <main id="admin-main" class="a-main container">
      <nav class="breadcrumb">
        <a href="index.html">Dashboard</a><span class="sep">/</span><span class="muted">Productos</span><span class="sep">/</span><span class="muted">Listado</span>
      </nav>

      <h1>Productos</h1>

      <div class="stickybar" id="toolbar">
        <div class="search">
          <input id="q" type="text" placeholder="Buscar por id, nombre o categoría…" aria-label="Buscar">
        </div>
        <div class="filters">
          <select id="fCat" aria-label="Filtrar por categoría"><option value="">Todas las categorías</option></select>
          <select id="fAct" aria-label="Filtrar por estado">
            <option value="">Todos</option><option value="1">Activos</option><option value="0">Inactivos</option>
          </select>
        </div>
        <span class="spacer"></span>
        <button id="btnExport" class="btn">Exportar CSV</button>
        <a class="btn primary" href="producto-nuevo.html">Nuevo producto</a>
      </div>

      <div id="bulkBar">
        <div class="muted" id="bulkCount">0 seleccionados</div>
        <span class="spacer"></span>
        <button class="btn" id="bulkOn">Activar</button>
        <button class="btn" id="bulkOff">Desactivar</button>
        <button class="btn danger" id="bulkDel">Eliminar</button>
        <button class="btn" id="bulkExport">Exportar selección</button>
      </div>

      <div id="empty" class="card hidden">
        <p class="muted">No hay productos cargados.</p>
        <a class="btn primary" href="producto-nuevo.html">Crear el primero</a>
      </div>

      <div id="wrap" class="table-wrap hidden">
        <table class="table-sm" id="tabla">
          <thead>
            <tr>
              <th class="col-sel"><input type="checkbox" id="selAll" aria-label="Seleccionar todos"></th>
              <th style="width:90px">Img</th>
              <th>Nombre</th>
              <th style="width:160px" data-col="cat">Categoría</th>
              <th style="width:120px">Precio</th>
              <th style="width:200px">Stock</th>
              <th style="width:100px">Activo</th>
              <th class="right" style="width:240px">Acciones</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </main>
  </div>

  <div class="a-dim" aria-hidden="true"></div>

  <div id="imgPreview" class="modal" aria-hidden="true">
    <div class="overlay" data-close></div>
    <div class="box" style="padding:10px;max-width:720px">
      <img id="imgPreviewImg" src="" alt="" style="display:block;max-width:100%;border-radius:12px">
    </div>
  </div>

  <script src="../assets/js/datos.js"></script>
  <script src="../assets/js/layout-admin.js"></script>
  <script>
    AX.mountLayout();

    const $=s=>document.querySelector(s),$$=s=>Array.from(document.querySelectorAll(s));
    const $q=$('#q'),$fCat=$('#fCat'),$fAct=$('#fAct'),$empty=$('#empty'),$wrap=$('#wrap'),$tbody=$('#tbody'),$selAll=$('#selAll');
    const $bulk=$('#bulkBar'),$bulkCount=$('#bulkCount'),$bulkOn=$('#bulkOn'),$bulkOff=$('#bulkOff'),$bulkDel=$('#bulkDel'),$bulkExp=$('#bulkExport');
    const $btnExport=$('#btnExport');
    const CLP=new Intl.NumberFormat('es-CL',{style:'currency',currency:'CLP',maximumFractionDigits:0});

    const escapeHtml=s=>String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const getData=()=>{try{return(DB&&DB.products&&DB.products.list)?DB.products.list():[]}catch{return[]}};

    function fillCategories(){
      const all=getData(),set=new Set(); all.forEach(p=>{if(p.categoria)set.add(p.categoria)});
      const curr=$fCat.value;
      $fCat.innerHTML='<option value="">Todas las categorías</option>'+Array.from(set).sort().map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
      if(Array.from(set).includes(curr))$fCat.value=curr;
    }

    const selected=new Set();
    function updBulkBar(){
      const total=$$('.row-sel').length, n=selected.size;
      $bulkCount.textContent=n+' seleccionados';
      $bulk.classList.toggle('show',n>0);
      $selAll.checked=n>0&&n===total;
      $selAll.indeterminate=n>0&&n<total;
    }

    function thumb(p){
      if(p&&p.imagen){
        const url=escapeHtml(p.imagen);
        return `<img class="thumb-sm" src="${url}" alt="" data-img="${url}" onerror="this.style.display='none'">`;
      }
      return `<div class="thumb-sm" title="Sin imagen"></div>`;
    }

    function qtyCtrl(id,stock){
      const s=Number(stock||0);
      return `
        <div class="qty" data-qty="${id}">
          <button class="qty-btn" data-dec>-</button>
          <input type="number" value="${s}" min="0" step="1">
          <button class="qty-btn" data-inc>+</button>
          <button class="btn small" data-save>Guardar</button>
        </div>`;
    }

    const activoBtn=(id,on)=>`<button class="btn small ${on?'subtle':''}" data-toggle="${id}" aria-pressed="${on?'true':'false'}">${on?'Sí':'No'}</button>`;

    function row(p){
      const id=String(p.id), editar=`producto-editar.html?id=${encodeURIComponent(id)}`, ver=`producto-mostrar.html?id=${encodeURIComponent(id)}`;
      return `
        <tr data-id="${id}">
          <td class="col-sel"><input type="checkbox" class="row-sel" data-id="${id}"></td>
          <td>${thumb(p)}</td>
          <td>
            <a href="${ver}" style="font-weight:700;text-decoration:none">${escapeHtml(p.nombre||'')}</a>
            <div class="muted" style="font-size:.9rem">#${escapeHtml(id)}</div>
          </td>
          <td data-col="cat">${escapeHtml(p.categoria||'—')}</td>
          <td>${CLP.format(Number(p.precio||0))}</td>
          <td>${qtyCtrl(id,p.stock)}</td>
          <td>${activoBtn(id,!!p.activo)}</td>
          <td class="right">
            <a class="btn" href="${ver}">Ver</a>
            <a class="btn" href="${editar}">Editar</a>
            <button class="btn danger" data-del>Eliminar</button>
          </td>
        </tr>`;
    }

    let lastTerm='',lastCat='',lastAct='';
    const applyFilters=list=>{
      const txt=lastTerm.toLowerCase().trim(),cat=lastCat.trim(),act=lastAct;
      return list.filter(p=>{
        if(txt){const blob=[String(p.id||''),p.nombre||'',p.categoria||''].join(' ').toLowerCase(); if(!blob.includes(txt))return false}
        if(cat&&String(p.categoria||'')!==cat)return false;
        if(act!==''&&String(p.activo?1:0)!==act)return false;
        return true;
      });
    };

    function render(){
      const all=getData(); fillCategories();
      const data=applyFilters(all), has=data.length>0;
      $empty.classList.toggle('hidden',has); $wrap.classList.toggle('hidden',!has);
      selected.clear(); updBulkBar();
      if(!has){$tbody.innerHTML='';return}
      let html=''; for(let i=0;i<data.length;i++) html+=row(data[i]); $tbody.innerHTML=html;
    }

    $q.addEventListener('input',()=>{lastTerm=$q.value;render()});
    $fCat.addEventListener('change',()=>{lastCat=$fCat.value;render()});
    $fAct.addEventListener('change',()=>{lastAct=$fAct.value;render()});

    $selAll.addEventListener('change',()=>{
      const on=$selAll.checked;
      $$('.row-sel').forEach(chk=>{chk.checked=on;const id=chk.getAttribute('data-id');on?selected.add(id):selected.delete(id)});
      updBulkBar();
    });

    document.addEventListener('click',e=>{
      const sel=e.target.closest('.row-sel');
      if(sel){const id=sel.getAttribute('data-id'); sel.checked?selected.add(id):selected.delete(id); updBulkBar(); return}

      const btnDel=e.target.closest('[data-del]');
      if(btnDel){
        const tr=btnDel.closest('tr'),id=tr?.getAttribute('data-id'); if(!id)return;
        if(confirm('¿Eliminar producto #'+id+'?')){
          try{const ok=DB?.products?.remove?DB.products.remove(id):false; if(ok){tr.remove();render()}else alert('No se pudo eliminar.')}catch{alert('Ocurrió un error al eliminar.')}
        }
        return;
      }

      const qty=e.target.closest('[data-qty]');
      if(qty){
        const id=qty.getAttribute('data-qty'),$in=qty.querySelector('input');
        if(e.target.matches('[data-dec]'))$in.value=Math.max(0,(+$in.value||0)-1);
        if(e.target.matches('[data-inc]'))$in.value=(+$in.value||0)+1;
        if(e.target.matches('[data-save]')){
          const nv=Math.max(0,parseInt($in.value,10)||0);
          try{DB?.products?.update&&DB.products.update(id,{stock:nv})}catch{}
          $in.value=nv;
        }
        return;
      }

      const tgl=e.target.closest('[data-toggle]');
      if(tgl){
        const id=tgl.getAttribute('data-toggle'),isOn=tgl.getAttribute('aria-pressed')==='true',next=!isOn;
        try{DB?.products?.update&&DB.products.update(id,{activo:next})}catch{}
        tgl.textContent=next?'Sí':'No'; tgl.setAttribute('aria-pressed',next?'true':'false');
        return;
      }
    });

    function getSelectedRows(){const ids=Array.from(selected),all=getData(); return all.filter(p=>ids.includes(String(p.id)))}

    $bulkOn.addEventListener('click',()=>{selected.forEach(id=>{try{DB.products.update(id,{activo:true})}catch{}});render()});
    $bulkOff.addEventListener('click',()=>{selected.forEach(id=>{try{DB.products.update(id,{activo:false})}catch{}});render()});
    $bulkDel.addEventListener('click',()=>{if(!selected.size)return; if(!confirm('¿Eliminar '+selected.size+' producto(s) seleccionados?'))return; selected.forEach(id=>{try{DB.products.remove(id)}catch{}});render()});

    const toCSV=rows=>{const head=['id','nombre','categoria','precio','stock','activo','imagen'],esc=v=>`"${String(v??'').replace(/"/g,'""')}"`;return head.join(',')+'\n'+rows.map(p=>head.map(k=>esc(p[k])).join(',')).join('\n')};
    function download(name,text){const blob=new Blob([text],{type:'text/csv;charset=utf-8;'}),a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name;document.body.appendChild(a);a.click();a.remove()}

    $btnExport.addEventListener('click',()=>{const data=applyFilters(getData()); if(!data.length)return; download('productos.csv',toCSV(data))});
    $bulkExp.addEventListener('click',()=>{const data=getSelectedRows(); if(!data.length)return; download('productos-seleccion.csv',toCSV(data))});

    const $modal=document.getElementById('imgPreview'),$modalImg=document.getElementById('imgPreviewImg');
    const openPreview=src=>{if(!$modal||!$modalImg)return; $modalImg.src=src; $modal.classList.add('open')};
    const closePreview=()=>{if(!$modal||!$modalImg)return; $modal.classList.remove('open'); $modalImg.src=''};
    document.addEventListener('click',e=>{const btn=e.target.closest('.thumb-sm'); if(btn){const src=btn.getAttribute('data-img')||btn.getAttribute('src'); if(src)openPreview(src)} if(e.target.closest('[data-close]'))closePreview()});
    document.addEventListener('keydown',e=>{if(e.key==='Escape')closePreview()});

    lastTerm=''; lastCat=''; lastAct=''; render();
    addEventListener('nx:products-seeded',render);
  </script>
</body>
</html>
