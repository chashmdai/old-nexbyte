<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Tienda — Inicio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="dark">
  <link href="../assets/css/tienda.css" rel="stylesheet">
</head>
<body>

  <main class="container section">
    <section class="hero reveal">
      <div class="hero-copy card soft">
        <h1>TIENDA ONLINE</h1>
        <p style="max-width:560px;margin:.5rem 0 1rem 0">
          Descubre nuestros productos destacados y mejora tu setup. Compra fácil, rápido y seguro.
        </p>
        <a class="btn btn-primary" href="productos.html">Ver productos</a>
      </div>

      <figure class="hero-img card">
        <img alt="Hero Nexbyte" src="../assets/img/placeholder/hero.jpg" width="1600" height="900">
      </figure>
    </section>

    <section class="section">
      <div class="reveal" style="display:flex;align-items:center;gap:10px">
        <h2 style="margin:0">Destacados</h2>
        <span style="flex:1 1 auto"></span>
        <a class="btn btn-ghost" href="productos.html">Ver todo</a>
      </div>

      <div id="empty" class="card" style="margin-top:10px;display:none">
        <p style="margin:.9rem;color:#b8c0cc">No hay productos disponibles por ahora.</p>
      </div>

      <section id="gridDest" class="products reveal" style="margin-top:10px"></section>
    </section>
  </main>

  <script src="../assets/js/datos.js"></script>
  <script src="../assets/js/layout.js"></script>
  <script src="../assets/js/ui.js"></script>

  <script>
  (function () {
    const $grid  = document.getElementById('gridDest');
    const $empty = document.getElementById('empty');
    const CLP = new Intl.NumberFormat('es-CL', { style:'currency', currency:'CLP', maximumFractionDigits:0 });

    const escapeHtml = (s)=> String(s??'').replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));

    function card(p){
      const id = String(p.id);
      const imgSrc = (p.imagen && String(p.imagen).trim())
        ? escapeHtml(p.imagen)
        : '../assets/img/placeholder/product-1.jpg';
      const href = 'detalle-producto.html?id=' + encodeURIComponent(id);

      return `
        <article class="card product" data-id="${id}">
          <a class="thumb" href="${href}">
            <img src="${imgSrc}" alt="${escapeHtml(p.nombre||'Producto')}" loading="lazy">
          </a>
          <div class="body">
            <a class="title" href="${href}">${escapeHtml(p.nombre||'')}</a>
            <div class="meta">${escapeHtml(p.categoria||'Otros')}</div>
            <div class="price">${CLP.format(Number(p.precio||0))}</div>
          </div>
          <div class="actions">
            <a class="btn btn-ghost btn-small" href="${href}">Ver detalles</a>
          </div>
        </article>`;
    }

    async function loadPinnedIds(){
      try{
        const res = await fetch('../assets/data/home.json', { cache:'no-cache' });
        if(!res.ok) throw new Error('404');
        const data = await res.json();
        const arr = data && (data.featuredIds || data.featured || data.destacados);
        return Array.isArray(arr) ? arr.map(String) : null;
      }catch{
        return null;
      }
    }

    function getByIds(ids){
      const out = [];
      const seen = new Set();
      ids.forEach(id=>{
        try{
          const p = DB.products.get(id);
          if (p && p.activo && Number(p.stock||0) > 0 && !seen.has(String(p.id))){
            seen.add(String(p.id));
            out.push(p);
          }
        }catch{}
      });
      return out;
    }

    function getFallback(count=4){
      try{
        const all = (DB && DB.products && DB.products.list) ? DB.products.list() : [];
        return all.filter(p => !!p.activo && Number(p.stock||0) > 0)
                  .sort((a,b)=> Number(b.id) - Number(a.id))
                  .slice(0, count);
      }catch{return [];}
    }

    async function getFeatured(){
      const pinned = await loadPinnedIds();
      if (pinned && pinned.length){
        const picked = getByIds(pinned);
        if (picked.length) return picked.slice(0,4); // aseguramos 4 en home
      }
      return getFallback(4);
    }

    async function render(){
      const data = await getFeatured();
      if (!data.length){
        $grid.innerHTML = '';
        $empty.style.display = 'block';
        return;
      }
      $empty.style.display = 'none';
      $grid.innerHTML = data.map(card).join('');
    }

    window.addEventListener('nx:products-seeded', render);
    render();
  })();
  </script>
</body>
</html>
